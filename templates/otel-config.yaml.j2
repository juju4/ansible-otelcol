{{ ansible_managed | comment }}

receivers:
  # https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/receiver/journaldreceiver
  journald:
    directory: /var/log/journal
{% if openobserve_agent_journald_extras %}
    {{ openobserve_agent_journald_extras | to_nice_yaml(indent=0,sort_keys=False) | indent(4, False) }}
{% endif %}
  # https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/receiver/filelogreceiver
  filelog/std:
    include:
      {{ openobserve_agent_filelog_include | to_nice_yaml(indent=0,sort_keys=False) | indent(6, False) }}
    # start_at: beginning
    include_file_path: true
  hostmetrics:
    root_path: /
    collection_interval: 30s
    scrapers:
      cpu:
      disk:
      filesystem:
      load:
      memory:
      network:
      paging:
      processes:
      # process: # a bug in the process scraper causes the collector to throw errors so disabling it for now
{% if openobserve_agent_config_receivers %}
  {{ openobserve_agent_config_receivers | to_nice_yaml(indent=2,sort_keys=False) | indent(2, False) }}
{% endif %}

processors:
{% if openobserve_agent_sampling_enable | bool %}
  # https://opentelemetry.io/docs/concepts/sampling/
  # https://opentelemetry.io/blog/2022/tail-sampling/
  tail_sampling:
    decision_wait: 10s
    num_traces: 100
    expected_new_traces_per_sec: 10
    policies:
      [
        {
          name: randomized-policy,
          type: probabilistic,
          probabilistic: { sampling_percentage: 25 },
          type: resp_code_c,
          status_code: { status_codes: [200] },
          log_file_path: '/var/log/squid/access_json.log',
        },
      ]
{% endif %}
  resourcedetection/system:
    detectors: ["system"]
    system:
      hostname_sources: ["os"]
  memory_limiter:
    check_interval: 1s
    limit_percentage: 75
    spike_limit_percentage: 15
  # https://github.com/open-telemetry/opentelemetry-collector/tree/main/processor/batchprocessor
  batch:
    send_batch_size: 10000
    timeout: 10s
{% if openobserve_agent_config_processors %}
  {{ openobserve_agent_config_processors | to_nice_yaml(indent=2,sort_keys=False) | indent(2, False) }}
{% endif %}

extensions:
  zpages: {}

# https://openobserve.ai/docs/ingestion/logs/otlp/
exporters:
{% if openobserve_agent_debug_enable | bool %}
  # https://github.com/open-telemetry/opentelemetry-collector/blob/main/exporter/debugexporter/README.md
  debug:
    verbosity: detailed
    sampling_initial: 5
    sampling_thereafter: 200
{% endif %}
  # https://github.com/open-telemetry/opentelemetry-collector-contrib/blob/main/exporter/fileexporter/README.md
  file/debug:
    # if systemd PrivateTmp, check /tmp/systemd-private-*-otel-collector.service-*/tmp/otel-debug.log
    path: /tmp/otel-debug.log
    rotation:
      max_megabytes: 10
      max_days: 3
      max_backups: 3
      localtime: false
    format: json
    # compression: zstd
  otlphttp/openobserve_default:
    endpoint: {{ openobserve_agent_server_url }}
{% if openobserve_agent_auth_key is defined and openobserve_agent_auth_key != None and openobserve_agent_auth_key | length > 0 %}
    headers:
      Authorization: "Basic {{ openobserve_agent_auth_key }}"
{% endif %}
  otlphttp/openobserve_journald:
    endpoint: {{ openobserve_agent_server_url }}
    headers:
{% if openobserve_agent_auth_key is defined and openobserve_agent_auth_key != None and openobserve_agent_auth_key | length > 0 %}
      Authorization: "Basic {{ openobserve_agent_auth_key }}"
{% endif %}
      stream-name: journald
{% if openobserve_agent_config_exporters %}
  {{ openobserve_agent_config_exporters | to_nice_yaml(indent=2,sort_keys=False) | indent(2, False) }}
{% endif %}

service:
  extensions: [zpages]
  pipelines:
    metrics:
      receivers: [hostmetrics]
      processors: [resourcedetection/system, memory_limiter, batch]
      exporters: [otlphttp/openobserve_default]
    logs:
      receivers: [filelog/std]
      processors: [resourcedetection/system, memory_limiter, batch]
      exporters: [otlphttp/openobserve_default]
    logs/journald:
      receivers: [journald]
      processors: [resourcedetection/system, memory_limiter, batch]
      exporters: [otlphttp/openobserve_journald]
{% if openobserve_agent_config_service_pipelines %}
    {{ openobserve_agent_config_service_pipelines | to_nice_yaml(indent=2,sort_keys=False) | indent(4, False) }}
{% endif %}
